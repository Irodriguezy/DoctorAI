    <script>
        let userName = '';
        let userLastName = '';
        let userPhone = '';
        let userEmail = '';

        function validateEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        function validatePhone(phone) {
            return /^\+569\d{8}$/.test(phone);
        }

        function showError(fieldId, message) {
            const field = document.getElementById(fieldId);
            const errorSpan = field.nextElementSibling;
            field.parentElement.classList.add('error');
            errorSpan.textContent = message;
            errorSpan.classList.add('visible');
        }

        function clearError(fieldId) {
            const field = document.getElementById(fieldId);
            field.parentElement.classList.remove('error');
            const errorSpan = field.nextElementSibling;
            errorSpan.classList.remove('visible');
        }

        function getCurrentTime() {
            const now = new Date();
            return now.toLocaleTimeString('es-CL', { hour: '2-digit', minute: '2-digit' });
        }

        function startChat() {
            const nombre = document.getElementById('user-nombre').value.trim();
            const apellido = document.getElementById('user-apellido').value.trim();
            const telefono = document.getElementById('user-telefono').value.trim();
            const email = document.getElementById('user-email').value.trim();
            let isValid = true;

            if (!nombre) {
                showError('user-nombre', 'El nombre es obligatorio');
                isValid = false;
            }

            if (!apellido) {
                showError('user-apellido', 'El apellido es obligatorio');
                isValid = false;
            }

            if (telefono && !validatePhone(telefono)) {
                showError('user-telefono', 'Formato: +56912345678');
                isValid = false;
            }

            if (email && !validateEmail(email)) {
                showError('user-email', 'Ingresa un email válido');
                isValid = false;
            }

            if (!isValid) return;

            userName = nombre;
            userLastName = apellido;
            userPhone = telefono;
            userEmail = email;

            document.getElementById('welcome-modal').classList.add('hidden');
            document.getElementById('user-info').classList.remove('hidden');
            document.getElementById('display-name').textContent = `${nombre} ${apellido}${telefono ? ' | Tel: ' + telefono : ''}${email ? ' | Email: ' + email : ''}`;
            document.getElementById('user-input').disabled = false;
            document.getElementById('send-button').disabled = false;
            document.getElementById('user-input').focus();

            addMessage('¡Hola! ¿En qué te puedo ayudar con tu salud dental? Pregúntame cualquier duda que tengas sobre tus dientes.', false);
        }

        function showTypingIndicator() {
            const typingIndicator = document.querySelector('.typing-indicator');
            typingIndicator.style.display = 'block';
        }

        function hideTypingIndicator() {
            const typingIndicator = document.querySelector('.typing-indicator');
            typingIndicator.style.display = 'none';
        }

        function addMessage(message, isUser) {
            const chatContainer = document.getElementById('chat-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${isUser ? 'user-message' : 'ai-message'}`;
            
            const time = getCurrentTime();
            messageDiv.innerHTML = `<strong>${isUser ? userName + ' ' + userLastName : 'AI Doctor'} (${time}):</strong> ${formatMessage(message, isUser)}`;
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function formatMessage(message, isUser) {
            if (!isUser && typeof message === 'object' && message.formatted) {
                let formattedResponse = '<div class="formatted-response">';
                message.content.forEach(item => {
                    formattedResponse += `<p><strong>${item.title}:</strong> ${item.description}</p>`;
                });
                formattedResponse += '</div>';
                return formattedResponse;
            }
            return message;
        }

        async function sendMessage() {
            const input = document.getElementById('user-input');
            const sendButton = document.getElementById('send-button');
            const message = input.value.trim();
            
            if (!message) return;

            addMessage(message, true);
            input.value = '';
            input.disabled = true;
            sendButton.disabled = true;
            showTypingIndicator();

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        message: message,
                        userName: userName,
                        userLastName: userLastName,
                        userPhone: userPhone,
                        userEmail: userEmail
                    })
                });

                const data = await response.json();
                hideTypingIndicator();
                addMessage(data.response, false);
            } catch (error) {
                console.error('Error:', error);
                hideTypingIndicator();
                addMessage('Lo siento, ocurrió un error al procesar tu mensaje. Por favor, intenta nuevamente.', false);
            } finally {
                input.disabled = false;
                sendButton.disabled = false;
                input.focus();
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const userInput = document.getElementById('user-input');
            userInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey && !this.disabled) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            document.getElementById('user-nombre').addEventListener('input', function() {
                this.value = this.value.replace(/[^a-zA-ZáéíóúÁÉÍÓÚñÑ\s]/g, '');
                if (this.value.trim()) {
                    clearError('user-nombre');
                }
            });

            document.getElementById('user-apellido').addEventListener('input', function() {
                this.value = this.value.replace(/[^a-zA-ZáéíóúÁÉÍÓÚñÑ\s]/g, '');
                if (this.value.trim()) {
                    clearError('user-apellido');
                }
            });

            document.getElementById('user-telefono').addEventListener('input', function() {
                this.value = this.value.replace(/[^0-9+]/g, '');
                if (this.value && !validatePhone(this.value)) {
                    showError('user-telefono', 'Formato: +56912345678');
                } else {
                    clearError('user-telefono');
                }
            });

            document.getElementById('user-email').addEventListener('input', function() {
                if (this.value && !validateEmail(this.value)) {
                    showError('user-email', 'Ingresa un email válido');
                } else {
                    clearError('user-email');
                }
            });
        });

        window.onload = function() {
            document.getElementById('user-nombre').focus();
        };
    </script>
</body>
</html>
